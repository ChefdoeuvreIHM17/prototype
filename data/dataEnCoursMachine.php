<?php
try {
    $conn = new PDO("odbc:HELIOSII O10","ETAT","ETAT");
    $sth = $conn->prepare("SELECT OFS.ID_OFS, OFS_PHASE.STATUT, OFS_PHASE.ID_PHASE, OFS_PHASE.PH_NAT_NATURE, ARTICLE.ID_ARTICLE, OFS.QTE_BONNE, OFS.QTE_LITIGE, OFS_CDC.LIBELLE, OFS.ETAT_OF,  MAX(HEURE.DATE_POINT), OUTILLAGE.REF_OUTILLAGE, OFS.N_RANG, OFS_CHAMP.TYPE_OF, PHASE_MEMO.MEMO
 FROM   (((((((HELIOS.OFS OFS INNER JOIN HELIOS.OFS_PHASE OFS_PHASE ON ((OFS.CD_OFS=OFS_PHASE.CD_OFS) AND (OFS.CD_GAMME=OFS_PHASE.CD_GAMME)) AND (OFS.N_LIEN=OFS_PHASE.N_LIEN)) INNER JOIN HELIOS.ARTICLE ARTICLE ON OFS.CD_ARTICLE=ARTICLE.CD_ARTICLE) LEFT OUTER JOIN HELIOS.OFS_CHAMP OFS_CHAMP ON OFS.CD_OFS=OFS_CHAMP.CD_OFS) LEFT OUTER JOIN HELIOS.HEURE HEURE ON (((OFS_PHASE.CD_OFS=HEURE.CD_OFS) AND (OFS_PHASE.CD_GAMME=HEURE.CD_GAMME)) AND (OFS_PHASE.N_LIEN=HEURE.N_LIEN)) AND (OFS_PHASE.CD_PHASE=HEURE.CD_PHASE)) INNER JOIN HELIOS.OFS_CDC OFS_CDC ON OFS_PHASE.CD_CDC=OFS_CDC.CD_OFS_CDC) LEFT OUTER JOIN HELIOS.PHASE_MEMO PHASE_MEMO ON (OFS_PHASE.CD_GAMME=PHASE_MEMO.CD_GAMME) AND (OFS_PHASE.CD_PHASE=PHASE_MEMO.CD_PHASE)) LEFT OUTER JOIN HELIOS.PH_OUTILLAGE PH_OUTILLAGE ON ((OFS_PHASE.CD_GAMME=PH_OUTILLAGE.CD_GAMME) AND (OFS_PHASE.CD_PHASE=PH_OUTILLAGE.CD_PHASE)) AND (OFS_PHASE.N_LIEN=PH_OUTILLAGE.N_LIEN)) LEFT OUTER JOIN HELIOS.OUTILLAGE OUTILLAGE ON PH_OUTILLAGE.CD_OUTILLAGE=OUTILLAGE.CD_OUTILLAGE
 WHERE  (OFS.ETAT_OF='EC' OR OFS.ETAT_OF='T')
 AND PHASE_MEMO.N_MEMO=3
 AND (OUTILLAGE.REF_OUTILLAGE IS  NULL  OR OUTILLAGE.REF_OUTILLAGE LIKE 'STD%' OR OUTILLAGE.REF_OUTILLAGE LIKE '%')
 group by OFS.ID_OFS, OFS_PHASE.STATUT, OFS_PHASE.ID_PHASE, OFS_PHASE.PH_NAT_NATURE, ARTICLE.ID_ARTICLE, OFS.QTE_BONNE, OFS.QTE_LITIGE, OFS_CDC.LIBELLE, OFS.ETAT_OF,  OUTILLAGE.REF_OUTILLAGE, OFS.N_RANG, OFS_CHAMP.TYPE_OF, PHASE_MEMO.MEMO
 ORDER BY OFS.ID_OFS,OFS_PHASE.ID_PHASE");
    $sth->execute();

    $result = $sth->fetchAll(PDO::FETCH_ASSOC);

    array_walk_recursive($result,function (&$value){
        $value = htmlspecialchars(html_entity_decode($value,ENT_QUOTES,'UTF-8'),ENT_QUOTES, 'UTF-8');
    });
    echo json_encode($result);
}catch(PDOException $ex){
    die(json_encode(array('outcome'=>false, 'message'=>'Unable to connect')));
}

?>